/* msg-rpc v0.1.1, 2013-10-11 11:11:52 */
!function(a,b,c){var d,e,f;!function(a){function b(a,b){return u.call(a,b)}function c(a,b){var c,d,e,f,g,h,i,j,k,l,m=b&&b.split("/"),n=s.map,o=n&&n["*"]||{};if(a&&"."===a.charAt(0))if(b){for(m=m.slice(0,m.length-1),a=m.concat(a.split("/")),j=0;j<a.length;j+=1)if(l=a[j],"."===l)a.splice(j,1),j-=1;else if(".."===l){if(1===j&&(".."===a[2]||".."===a[0]))break;j>0&&(a.splice(j-1,2),j-=2)}a=a.join("/")}else 0===a.indexOf("./")&&(a=a.substring(2));if((m||o)&&n){for(c=a.split("/"),j=c.length;j>0;j-=1){if(d=c.slice(0,j).join("/"),m)for(k=m.length;k>0;k-=1)if(e=n[m.slice(0,k).join("/")],e&&(e=e[d])){f=e,g=j;break}if(f)break;!h&&o&&o[d]&&(h=o[d],i=j)}!f&&h&&(f=h,g=i),f&&(c.splice(0,g,f),a=c.join("/"))}return a}function g(b,c){return function(){return n.apply(a,v.call(arguments,0).concat([b,c]))}}function h(a){return function(b){return c(b,a)}}function i(a){return function(b){q[a]=b}}function j(c){if(b(r,c)){var d=r[c];delete r[c],t[c]=!0,m.apply(a,d)}if(!b(q,c)&&!b(t,c))throw new Error("No "+c);return q[c]}function k(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function l(a){return function(){return s&&s.config&&s.config[a]||{}}}var m,n,o,p,q={},r={},s={},t={},u=Object.prototype.hasOwnProperty,v=[].slice;o=function(a,b){var d,e=k(a),f=e[0];return a=e[1],f&&(f=c(f,b),d=j(f)),f?a=d&&d.normalize?d.normalize(a,h(b)):c(a,b):(a=c(a,b),e=k(a),f=e[0],a=e[1],f&&(d=j(f))),{f:f?f+"!"+a:a,n:a,pr:f,p:d}},p={require:function(a){return g(a)},exports:function(a){var b=q[a];return"undefined"!=typeof b?b:q[a]={}},module:function(a){return{id:a,uri:"",exports:q[a],config:l(a)}}},m=function(c,d,e,f){var h,k,l,m,n,s,u=[];if(f=f||c,"function"==typeof e){for(d=!d.length&&e.length?["require","exports","module"]:d,n=0;n<d.length;n+=1)if(m=o(d[n],f),k=m.f,"require"===k)u[n]=p.require(c);else if("exports"===k)u[n]=p.exports(c),s=!0;else if("module"===k)h=u[n]=p.module(c);else if(b(q,k)||b(r,k)||b(t,k))u[n]=j(k);else{if(!m.p)throw new Error(c+" missing "+k);m.p.load(m.n,g(f,!0),i(k),{}),u[n]=q[k]}l=e.apply(q[c],u),c&&(h&&h.exports!==a&&h.exports!==q[c]?q[c]=h.exports:l===a&&s||(q[c]=l))}else c&&(q[c]=e)},d=e=n=function(b,c,d,e,f){return"string"==typeof b?p[b]?p[b](c):j(o(b,c).f):(b.splice||(s=b,c.splice?(b=c,c=d,d=null):b=a),c=c||function(){},"function"==typeof d&&(d=e,e=f),e?m(a,b,c,d):setTimeout(function(){m(a,b,c,d)},4),n)},n.config=function(a){return s=a,s.deps&&n(s.deps,s.callback),n},d._defined=q,f=function(a,c,d){c.splice||(d=c,c=[]),b(q,a)||b(r,a)||(r[a]=[a,c,d])},f.amd={jQuery:!0}}(),f("almond",function(){}),f("consts",[],function(){"use strict";var a="$$:";return{libIden:"msg-rpc",version:1,sysKeyPre:a,hashTagKey:a+"hash"}}),f("utils",["consts"],function(a){"use strict";function b(){}var d="object"==typeof sumLogger?sumLogger:console,e="undefined"!=typeof module&&module.exports;(!d.debug||e)&&(d.debug=d.info);var f={log:d,debug:function(a){this.log=a?d:{error:function(){d.error.apply(d,arguments)},warn:b,info:b,debug:b,trace:b},this.__debugMode=a},isDebug:function(){return!!this.__debugMode},isNodeSvr:function(){return e},timestamp:function(){return(new Date).getTime()},randomInt:function(a,b){return Math.floor(Math.random()*(b-a+1))+a},randomStr:function(a){var b="",c="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",d=c.length;a||(a=6);for(var e=0;a>e;e++)b+=c.charAt(this.randomInt(0,d-1));return b},extend:function(a){return a||(a={}),Array.prototype.slice.call(arguments,1).forEach(function(b){if(b)for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c])}),a},subset:function(a){var b={};return a&&a.length?(this.isArray(a)||(a=[a]),Array.prototype.slice.call(arguments,1).forEach(function(c){if(c)for(var d=0,e=a.length;e>d;d++)c.hasOwnProperty(a[d])&&(b[a[d]]=c[a[d]])}),b):b},subsetExcept:function(a){var b={};return a&&a.length?(this.isArray(a)||(a=[a]),Array.prototype.slice.call(arguments,1).forEach(function(c){if(c)for(var d in c)!c.hasOwnProperty(d)||a.indexOf(d)>=0||(b[d]=c[d])}),b):b},construct:function(a,b){function c(){return a.apply(this,b)}return c.prototype=a.prototype,new c},isEqual:function(b,d){if(b===d)return!0;if(null===b||null===d)return!1;if(b!==b&&d!==d)return!0;var e,f,g=a.hashTagKey,h=typeof b,i=typeof d,j=null;if(h==i&&"object"==h){if(!this.isArray(b)){if(g&&b[g]&&d[g]&&b[g]===d[g])return!0;f={};for(j in b)if(b.hasOwnProperty(j)&&!this.isSysOwnedFld(j)){if(!this.isEqual(b[j],d[j]))return!1;f[j]=!0}for(j in d)if(d.hasOwnProperty(j)&&!this.isSysOwnedFld(j)&&!f[j]&&d[j]!==c&&"function"!=typeof d[j])return!1;return!0}if(b.length==d.length){for(e=b.length,j=0;e>j;j++)if(!this.isEqual(b[j],d[j]))return!1;return!0}}return!1},isArray:function(a){return Array.isArray?Array.isArray(a):"[object Array]"==Object.prototype.call(a)},isObject:function(a){return null!==a&&"object"==typeof a},isFunction:function(a){return a&&"function"==typeof a},ownProps:function(a){if(!a)return{};var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return a},nextTick:function(a){("object"==typeof process&&process.nextTick?process.nextTick:function(a){setTimeout(a,0)})(a)},size:function(a){if(null===a)return 0;if(a.length===+a.length)return a.length;var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},inherit:function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);return c.prototype=b.prototype,a.prototype=new c,a.__super__=b.prototype,a},hidePrivate:function(a){function b(a,b){return function(){return a.apply(b,arguments)}}var c={};for(var d in a)d.charAt&&"_"!=d.charAt(0)&&("function"==typeof a[d]?c[d]=b(a[d],a):a.hasOwnProperty(d)&&(c[d]=a[d]));return c},copy:function(a){var b;if(this.isArray(a)){b=[];for(var c=0,d=a.length;d>c;c++)b.push(this.copy(a[c],1));return b}if(this.isObject(a)){b={};for(var e in a)a.hasOwnProperty(e)&&!this.isSysOwnedFld(e)&&(b[e]=this.copy(a[e],1));return b}return a},walk:function(a,b,d){function e(a,g,h,i){if(!(a>=d))if(f.isObject(g))for(var j in g)g.hasOwnProperty(j)&&e(a+1,g[j],g,j);else if(f.isArray(g))for(var k=0,l=g.length;l>k;k++)e(a+1,g[k],g,k);else{var m=b(g,a);if(m===c)return;if(!h)return m;h[i]=m}}d=d||10;var f=this;return e(0,a)},trim:function(a){return a?a.trim?a.trim():a.replace(/^\s+|\s+$/g,""):""},ucfirst:function(a){return a.charAt(0).toUpperCase()+a.substr(1)},strHashCode:function(a){var b=0;if(0===a.length)return b;for(var c,d=0,e=a.length;e>d;d++)c=a.charCodeAt(d),b=(b<<5)-b+c,b&=b;return b},getHashTag:function(a){return this.strHashCode(JSON.stringify(a))},setHashTag:function(b,c){b&&(b[a.hashTagKey]&&delete b[a.hashTagKey],b[a.hashTagKey]=c||this.getHashTag(b))},isSysOwnedFld:function(b){return 0===b.indexOf(a.sysKeyPre)},inArray:function(a,b){return this.arrayIndex(a,b)>=0},arrayIndex:function(a,b){return this.isArray(b)?b.indexOf(a):-1}};return f.debug(0),f}),f("errors",[],function(){"use strict";return{BadReq:"400: Bad Request",Timeout:"408: Timeout",NotFound:"404: NotFound",NetError:"600: Network error",Unknown:"-1: Unknown error",Failed:"-2: Failed"}}),f("event",["utils"],function(a){"use strict";function b(){this.__evHash={}}return a.extend(b.prototype,{on:function(a,b,c){if(this.__multiCall(a,b,this.on))return this;var d=this.__evHash;d[a]||(d[a]=[]);var e=d[a],f=this.__index(e,b);if(0>f){"number"!=typeof c&&(c=10);for(var g=e.length,h=0,i=e.length;i>h;h++)if(c>e[h].priority){g=h;break}e.splice(g,0,{listener:b,priority:c})}return this},once:function(a,b,c){function d(){e.__callListenser(b,arguments),e.off(a,d)}if(this.__multiCall(a,b,this.once))return this;var e=this;return this.on(a,d,c),this},offAll:function(){for(var a in this.__evHash)this.off(a);return this.__evHash={},this},off:function(a,b){if(this.__multiCall(a,b,this.off))return this;var c=this.__evHash;if(c[a]){var d=c[a];if("undefined"==typeof b){var e=d.length;return d.length=0,e}var f=this.__index(d,b);return f>=0?(d.splice(f,1),1):0}},emit:function(a){var b,c,d=this.__evHash,e=0;return c=d[a],c&&c.length&&(b=Array.prototype.slice.call(arguments,1),e+=this.__callListenerList(c,b)),c=d["*"],c&&c.length&&(b=Array.prototype.slice.call(arguments),e+=this.__callListenerList(c,b)),e},onDestroy:function(a,b){return this.on("__destroy",a,b),this},destroy:function(){return this.__destroying?void 0:(this.__destroying=1,this.emit("__destroy",this),this.offAll(),this)},__multiCall:function(b,c,d){if(a.isObject(b)&&"undefined"==typeof c){for(var e in b)d.call(this,e,b[e]);return!0}if("string"==typeof b){var f=b.split(/[\s,]+/);if(f.length>1){for(var g=0,h=f.length;h>g;g++)d.call(this,f[g],c);return!0}}return!1},__index:function(b,c){var d=-1;return b.some(function(b,e){return a.isEqual(b.listener,c)?(d=e,!0):void 0}),d},__callListenser:function(a,b){var d=null,e=null;return"function"==typeof a?(d=a,e=this):2==a.length&&(d=a[1],e=a[0]),d?[1,d.apply(e,b)]:[0,c]},__callListenerList:function(a,b){if(!a||!a.length)return 0;a=[].concat(a);for(var c,d=0,e=0,f=a.length;f>e&&(c=this.__callListenser(a[e].listener,b),d+=c[0],c[1]!==!1);e++);return d}}),b}),f("rpcBase",["utils","consts","errors","event"],function(a,b,c,d){"use strict";function e(b){this.PipeNs={Rpc:"rs-rpc",Msger:"rs-msger"},this.__pkSeqBase=1,this.__idenStr=a.randomStr(10),e.__super__.constructor.apply(this,arguments),this.setSender(b)}return a.inherit(e,d),a.extend(e.prototype,{setSender:function(b){if(!a.isObject(b)||!a.isFunction(b.sendMessage))throw new Error("msgSender should implement function sendMessage(msg, [callback])");this.__msgSender=b},sendPipeMsg:function(a,c){this.__msgSender.sendMessage.apply(this.__msgSender,[{u:b.libIden,v:b.version,i:this.__idenStr,s:this.__pkSeqBase++,p:c,m:a}].concat(Array.prototype.slice.call(arguments,2)))},onPipeMsg:function(a,b){this.on("pipe_msg_"+a,b)},isRpcMsg:function(c){return a.isObject(c)&&c.u==b.libIden},message:function(b){a.isObject(b)&&b.p&&b.m?this.emit.apply(this,["pipe_msg_"+b.p,b.m].concat(Array.prototype.slice.call(arguments,1))):a.log.warn("Unknown msg format: ",b)}}),e}),f("messenger",["utils","event","errors"],function(a,b,d){"use strict";function e(b){e.__super__.constructor.apply(this,arguments),this.__idenStr=a.randomStr(10),this.__seqBase=1,this.__cmdCbHash={},this.__msgInCount=this.__msgOutCount=0,this.setSender(b),this.__listenCmd(),this.__bindDefCmds(),this.__markActive()}var f="__ResCmdConsumed",g={ping:function(a,b,c){c(null,{timestamp:Date.now(),args:b})}},h="__";e.getLocalPair=function(){var a=new e,b=new e;return a.setSender({sendMessage:function(a,c){b.message(a),c&&c(null,!0)}}),b.setSender({sendMessage:function(b,c){a.message(b),c&&c(null,!0)}}),[a,b]},a.inherit(e,b),a.extend(e.prototype,{sendMessage:function(b,d,e){"function"==typeof d&&(e=d,d=!1);var f=this;return f.__msgSender.sendMessage({p:d||h,m:b},function(b){b?f.__reduceLife():(f.__lastMsgOutTs=a.timestamp(),f.__msgOutCount++,f.__markActive()),e&&e.apply(c,arguments)}),this},onMessage:function(b,c,d){function e(a){if(a.p&&(!c||"*"==c||a.p==c)){var d=b(a.m,a.p);return d==f?(g.off("__msg",e),!1):d}}if(!a.isFunction(b))throw new Error("a callback function must be provided");"number"==typeof c&&(d=c,c=!1);var g=this;return c=c||h,this.on("__msg",e,d),this},callCmd:function(b,c,e,g){"function"==typeof c&&(e=c,g=e,c={});var h={timeout:1e4};g=a.extend({},h,g);var i="c"+this.__seqBase++ +"_"+this.__idenStr,j=this,k=this.__getCmdPipe(b,i),l=setTimeout(function(){j.message({p:k,m:{err:d.Timeout,result:"timeout within "+g.timeout}})},g.timeout);return this.onMessage(function(c){clearTimeout(l),a.log.debug("msger cmd back",b);try{e(c.err,c.result)}catch(d){a.log.error(d.stack)}return f},k,99999999),this.sendMessage({cmd:b,args:c,ctag:i},k,function(a){a&&j.message({p:k,m:{err:d.NetError,result:a}})}),a.log.debug("msger send cmd",b),this},onCmd:function(b,c){return"function"==typeof b&&(c=b,b="*"),this.__cmdCbHash[b]?(a.log.error("cmd alreay listened: "+b),void 0):(this.__cmdCbHash[b]=c,this)},__getCmdPipe:function(a,b){return"c_"+a+"_"+b},__listenCmd:function(){function b(b){return function(d,e){c.sendMessage({err:d,result:e},b,function(b){b&&a.log.warn("cmd resp failed",cmd)})}}var c=this;this.onMessage(function(d,e){if(a.isObject(d)&&d.cmd&&d.ctag&&e==c.__getCmdPipe(d.cmd,d.ctag)){var f=!1;for(var g in c.__cmdCbHash)if(d.cmd==g){f=c.__cmdCbHash[g];break}if(!f&&"*"!=d.cmd&&c.__cmdCbHash["*"]&&(f=c.__cmdCbHash["*"]),f){try{f(d.cmd,d.args||{},b(e))}catch(h){a.log.error(h.stack)}return!1}b(e)("404 Unkown cmd: "+d.cmd)}},"*",9999999)},setSender:function(b){if(!a.isObject(b)||!a.isFunction(b.sendMessage))throw new Error("msgSender should implement function sendMessage");this.__msgSender=b},getStatus:function(){return{msgIn:this.__msgInCount,msgOut:this.__msgOutCount,lifeValue:this.__lifeValue,lastAct:this.__lastActiveTs,lastOut:this.__lastMsgOutTs,lastIn:this.__lastMsgInTs}},__bindDefCmds:function(){for(var a in g)this.onCmd(a,g[a])},__markActive:function(){this.__lastActiveTs=a.timestamp(),this.__lifeValue=5},__reduceLife:function(){this.__lifeValue--,this.__lifeValue<=0&&a.timestamp()-this.__lastActiveTs>6e4&&(a.log.warn("messenger dead",this),this.emit("__dead",this.getStatus()))},destroy:function(){e.__super__.destroy.apply(this,arguments),this.setSender({sendMessage:function(){a.log.error("messenger has been destroyed")}}),a.log.debug("Messenger destroyed")},message:function(){return this.emit.apply(this,["__msg"].concat(Array.prototype.slice.call(arguments))),this.__lastMsgInTs=a.timestamp(),this.__msgInCount++,this.__markActive(),this}});var i={sendCmd:"callCmd",rpc:"callCmd",onRpc:"onCmd",sendMsg:"sendMessage",onMsg:"onMessage"};for(var j in i)e.prototype[j]=e.prototype[i[j]];return e}),f("rpcClient",["utils","consts","errors","rpcBase","messenger"],function(a,b,d,e,f){"use strict";function g(){g.__super__.constructor.apply(this,arguments),this.__cmdCbHash={},this.__msgerHash={},this.__rpcSeqBase=1,this.onPipeMsg(this.PipeNs.Rpc,function(b){a.isObject(b)&&b.request&&this.__finRpc(b.request.cmd,b.request.tag,b.err,b.result,b.isService)}),this.onPipeMsg(this.PipeNs.Msger,function(b){if(a.isObject(b)&&b.tag){var c=this.__msgerHash;return c[b.tag]?(c[b.tag].message(b.msg),void 0):void 0}})}return a.inherit(g,e),a.extend(g.prototype,{rpc:function(b,c,e,f){if("string"!=typeof b)throw new Error("param cmd should be a string");if(c instanceof Function?(e=c,c={}):c=c||{},!a.isObject(c))throw new Error("param args should be an object, e.g. {a:1, b:2}");var g=this,h=this.__cmdCbHash,i="r"+this.__rpcSeqBase++ +"_"+this.__idenStr,j={timeout:1e4};f=a.extend({},j,f);var k=f.timeout;return e=e instanceof Function?e:!1,h[i]={cb:e,timeout:k,timeoutHandler:setTimeout(function(){a.log.info("Cmd timeout: "+b+": "+i),g.__finRpc(b,i,d.Timeout,"Time out: "+k)},k)},this.sendPipeMsg({cmd:b,args:c,tag:i},this.PipeNs.Rpc,function(a){a&&g.__finRpc(b,i,a,"Send out failed")}),a.log.debug("Rpc: ",b),i},__finRpc:function(b,d,e,f,g){a.log.debug("Rpc back: ",b);var h=this.__cmdCbHash,i=h[d];if(i&&(delete h[d],i.timeoutHandler&&clearTimeout(i.timeoutHandler),i.cb)){var j=[e,f];g&&j.push(this.__getMessenger(d)),i.cb.apply(c,j)}},__getMessenger:function(b){var c=this,d=this.__msgerHash;if(d[b])return d[b];var e=new f({sendMessage:function(a,d){c.sendPipeMsg({msg:a,tag:b},c.PipeNs.Msger,function(a){a&&d&&d(a,null)})}});return e.onDestroy(function(){delete d[b]}),d[b]=e,a.hidePrivate(e)}}),g});var g={Client:e("rpcClient")},h="undefined"!=typeof module&&module.exports;h?module.exports=g:"undefined"!=typeof a&&(a.MsgRpc=g)}(window,document,void 0);